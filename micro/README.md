# Micro-Benchmarking

## WARNING
**THIS BENCHMARK DOES NOT MEASURE WHAT YOU THINK IT DOES**
The "Google Benchmark" assumes that all calls to some function
are all exactly the same, and that there is no hysteresis or
side-effects.  This means that this benchmark is not suitable
for measuring AtomSpace insertions, because these have both
hysteresis and side-effects.  Thus, the reported times
***ARE JUST PLAIN WRONG!***

The issue is this: Say we want to measure how much time it takes
to add 1M Atoms to the atomspace, vs how much time it takes to
add 64K Atoms. Well, the actual timing loop does NOT actually
iterate 1M times, or 64K times. It iterates some other number of
times that is not predictable.

Thus, to measure 64K insertions, you have to count to 64K, and then
clear the atomspace... inside the timing loop!  But we didn't want
to measure how long it takes to clear the atomspace! Worse, the loop
might run 150K times, so there are 150K == 64K+64K+22K adds, and
the short fill-up at the end skews everything.   Worse still, if
you ask for 1M insertions, the loop maight only run to 400K, so you
never even got to the end of the fill!

As a result, the numbers generated by this benchmark are insane.
They might give you some kind of general impression for what's going
on, but they will be wrong by factors of 2x or 4x or 5x ... usually,
reporting performance that is much faster than what it actually is.

If you have a lot of free time on your hands, maybe you can read the
docs and figure out how to fix this thing and make it work right.
But right now, its fubar'ed and totally unusable.


## Prerequisites
This requires the "Google Benchmark" micro-benchmarking tool v1.3.0 or higher.

Google Benchmark is a library supporting C++ micro-benchmarking.

Install it from repository:
```
apt-get install libbenchmark-dev
```

Build and install it:

```
    git clone https://github.com/google/benchmark.git google-benchmark
    mkdir google-benchmark/build
    cd google-benchmark/build
    cmake -DCMAKE_BUILD_TYPE=Release -DBENCHMARK_ENABLE_GTEST_TESTS=OFF ..
    make
    sudo make install
```

## Running
Run benchmarks:

```
cd <BUILD_DIR>/micro
./benchmark
```

Benchmark command line parameters:

```
benchmark [--benchmark_list_tests={true|false}]
          [--benchmark_filter=<regex>]
          [--benchmark_min_time=<min_time>]
          [--benchmark_repetitions=<num_repetitions>]
          [--benchmark_report_aggregates_only={true|false}
          [--benchmark_format=<console|json|csv>]
          [--benchmark_out=<filename>]
          [--benchmark_out_format=<json|console|csv>]
          [--benchmark_color={auto|true|false}]
          [--benchmark_counters_tabular={true|false}]
          [--v=<verbosity>]
```

See the Google Benchmark documentation
https://github.com/google/benchmark/blob/master/README.md and
```DEFINE_*``` definitions in
https://github.com/google/benchmark/blob/master/src/benchmark.cc
for explanation of the command line parameters.
